# Ø±Ø¨Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§ÛŒÙ„ ØªÙ„Ú¯Ø±Ø§Ù… - ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§
import logging
import json
import os
import hashlib
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler, ConversationHandler
import asyncio

# ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    handlers=[
        logging.FileHandler('bot.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª
BOT_TOKEN = "8186060654:AAE_uYgaGEDaTwgkyz8ruFJboTXshPd-6qQ"  # ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø§Ø² @BotFather
ADMIN_IDS = [8048628136]  # Ø¢ÛŒØ¯ÛŒ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
FILES_DIR = "uploaded_files"  # Ù¾ÙˆØ´Ù‡ Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
FILES_DB = "files_database.json"  # ÙØ§ÛŒÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
USERS_DB = "/content/drive/MyDrive/sepi_bot/users.json" # Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†

# Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
os.makedirs(FILES_DIR, exist_ok=True)

class FileManager:
    def __init__(self):
        self.files_db = self.load_files_db()
        self.users_db = self.load_users_db()

    def load_files_db(self):
        """Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§"""
        try:
            with open(FILES_DB, 'r', encoding='utf-8') as f:
                return json.load(f)
        except FileNotFoundError:
            return {}

    def save_files_db(self):
        """Ø°Ø®ÛŒØ±Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§"""
        with open(FILES_DB, 'w', encoding='utf-8') as f:
            json.dump(self.files_db, f, ensure_ascii=False, indent=2)

    def load_users_db(self):
        """Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†"""
        try:
            with open(USERS_DB, 'r', encoding='utf-8') as f:
                return json.load(f)
        except (FileNotFoundError, json.JSONDecodeError):
            return {}

    def save_users_db(self):
        """Ø°Ø®ÛŒØ±Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†"""
        with open(USERS_DB, 'w', encoding="utf-8") as f:
            json.dump(self.users_db, f, ensure_ascii=False, indent=2)

    def add_user(self, user_id, username):
        """Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³"""
        if str(user_id) not in self.users_db:
            self.users_db[str(user_id)] = {'username': username, 'join_date': datetime.now().isoformat()}
            self.save_users_db()

    def add_file(self, file_id, file_info):
        """Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³"""
        unique_id = hashlib.md5(f"{file_id}{datetime.now()}".encode()).hexdigest()[:12]

        self.files_db[unique_id] = {
            'file_id': file_id,
            'file_name': file_info['file_name'],
            'file_size': file_info['file_size'],
            'file_type': file_info['file_type'],
            'upload_date': datetime.now().isoformat(),
            'uploader_id': file_info['uploader_id'],
            'download_count': 0,
            'file_path': file_info['file_path'] # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„
        }

        self.save_files_db()
        return unique_id

    def get_file(self, unique_id):
        """Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„"""
        return self.files_db.get(unique_id)

    def delete_file(self, unique_id):
        """Ø­Ø°Ù ÙØ§ÛŒÙ„ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³"""
        if unique_id in self.files_db:
            # Ø­Ø°Ù ÙØ§ÛŒÙ„ ÙÛŒØ²ÛŒÚ©ÛŒ
            file_path = self.files_db[unique_id].get('file_path')
            # ØªÙˆØ¬Ù‡: Ø§Ú¯Ø± file_path Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ Ø§Ø³ØªØŒ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø­Ø°Ù ÙÛŒØ²ÛŒÚ©ÛŒ Ù†ÛŒØ³Øª.
            # Ø§Ú¯Ø± Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø­Ø°Ù ÙØ§ÛŒÙ„ Ø§Ø² Ø¯Ø±Ø§ÛŒÙˆ Ø¨ÙˆØ¯ØŒ Ø¨Ø§ÛŒØ¯ API Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯.

            del self.files_db[unique_id]
            self.save_files_db()
            return True
        return False

    def increment_download(self, unique_id):
        """Ø§ÙØ²Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ù„ÙˆØ¯"""
        if unique_id in self.files_db:
            self.files_db[unique_id]['download_count'] += 1
            self.save_files_db()

# Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÙˆÙ†Ù‡ Ù…Ø¯ÛŒØ± ÙØ§ÛŒÙ„
file_manager = FileManager()

def is_admin(user_id):
    """Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø±"""
    return user_id in ADMIN_IDS

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    file_manager.add_user(user.id, user.username or "") # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³

    # Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù† start (Ù…Ø«Ù„Ø§Ù‹ get_xxxxx)
    if context.args:
        arg = context.args[0]
        if arg.startswith("get_"):
            unique_id = arg[4:]
            file_info = file_manager.get_file(unique_id)

            if not file_info:
                await update.message.reply_text("âŒ ÙØ§ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø§Ø³Øª!")
                return

            # Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ (Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø² Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
            await send_file_from_drive(update, context, file_info, unique_id) # Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
            return

    # Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯ Ù…Ø¹Ù…ÙˆÙ„ÛŒ
    keyboard = [
        [InlineKeyboardButton("ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„", callback_data="upload_file")],
        [InlineKeyboardButton("ğŸ—‘ï¸ Ø­Ø°Ù ÙØ§ÛŒÙ„", callback_data="delete_file")],
        [InlineKeyboardButton("ğŸ“Š Ø¢Ù…Ø§Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§", callback_data="file_stats")]
    ]
    if is_admin(user.id):
         keyboard.append([InlineKeyboardButton("ğŸ“¢ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ", callback_data="broadcast")])

    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        f"Ø³Ù„Ø§Ù… {user.first_name}! âœ¨\nØ¨Ù‡ Ø±Ø¨Ø§Øª Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ.",
        reply_markup=reply_markup
    )


async def send_file_from_drive(update: Update, context: ContextTypes.DEFAULT_TYPE, file_info: dict, unique_id: str):
    """Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ"""
    try:
        caption = f"""
ğŸ“ {file_info['file_name']}
ğŸ“… Ø¢Ù¾Ù„ÙˆØ¯: {datetime.fromisoformat(file_info['upload_date']).strftime('%Y/%m/%d')}
ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯: {file_info['download_count'] + 1}
"""
        google_drive_link = file_info.get('file_path')

        if not google_drive_link or not google_drive_link.startswith("https://drive.google.com/uc?id="):
             await update.message.reply_text("âŒ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!")
             logger.error(f"Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„ {unique_id}: {google_drive_link}")
             return

        # ØªÙ„Ú¯Ø±Ø§Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ÙØ§ÛŒÙ„ Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø§Ø² Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†Ø¯
        await context.bot.send_document(
            chat_id=update.effective_chat.id,
            document=google_drive_link,
            caption=caption
        )

        # Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯
        file_manager.increment_download(unique_id)

        logger.info(f"ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯: {unique_id} ØªÙˆØ³Ø· {update.effective_user.id}")

    except Exception as e:
        await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„! Ù…Ù…Ú©Ù† Ø§Ø³Øª ÙØ§ÛŒÙ„ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.")
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ {unique_id}: {e}")


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ inline"""
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id

    if not is_admin(user_id):
        await query.edit_message_text("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù†Ø¯Ø§Ø±ÛŒØ¯!")
        return

    if query.data == 'upload_file':
        await query.edit_message_text("""
ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„:

ğŸ“‹ Ù…Ø±Ø§Ø­Ù„ Ø¢Ù¾Ù„ÙˆØ¯:
1ï¸âƒ£ ÙØ§ÛŒÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯
2ï¸âƒ£ Ø±Ø¨Ø§Øª Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
3ï¸âƒ£ Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯

ğŸ’¡ Ø§Ù†ÙˆØ§Ø¹ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡:
â€¢ ÙˆÛŒØ¯ÛŒÙˆ (MP4, AVI, MKV)
â€¢ ØµÙˆØª (MP3, WAV, FLAC)
â€¢ ØªØµÙˆÛŒØ± (JPG, PNG, GIF)
â€¢ Ø³Ù†Ø¯ (PDF, DOC, ZIP)

ğŸ‘‡ ÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:
""")

        context.user_data['waiting_for_file'] = True

    elif query.data == 'delete_file':
        files_list = ""
        if file_manager.files_db:
            files_list = "ğŸ—‚ï¸ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:\n\n"
            for unique_id, file_info in file_manager.files_db.items():
                upload_date = datetime.fromisoformat(file_info['upload_date']).strftime('%Y/%m/%d')
                files_list += f"ğŸ”¹ {file_info['file_name']}\n"
                files_list += f"   ğŸ“… {upload_date} | ğŸ“¥ {file_info['download_count']} Ø¯Ø§Ù†Ù„ÙˆØ¯\n"
                files_list += f"   ğŸ†” Ú©Ø¯: {unique_id}\n\n"

            files_list += "ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø­Ø°ÙØŒ Ú©Ø¯ ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:"
        else:
            files_list = "âŒ Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª!"

        await query.edit_message_text(files_list)
        context.user_data['waiting_for_delete'] = True

    elif query.data == 'file_stats':
        if not file_manager.files_db:
            await query.edit_message_text("ğŸ“Š Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!")
            return

        total_files = len(file_manager.files_db)
        total_downloads = sum(f['download_count'] for f in file_manager.files_db.values())

        # Ø¢Ù…Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ ÙØ§ÛŒÙ„
        file_types = {}
        for file_info in file_manager.files_db.values():
            file_type = file_info['file_type']
            file_types[file_type] = file_types.get(file_type, 0) + 1

        stats_text = f"""
ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ù…Ù„ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§:

ğŸ“ Ú©Ù„ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§: {total_files}
ğŸ“¥ Ú©Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯Ù‡Ø§: {total_downloads}
ğŸ“ˆ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø§Ù†Ù„ÙˆØ¯: {total_downloads/total_files:.1f}

ğŸ“‹ Ø¢Ù…Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹:
"""

        for file_type, count in file_types.items():
            stats_text += f"â€¢ {file_type}: {count} ÙØ§ÛŒÙ„\n"

        # Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
        popular_files = sorted(
            file_manager.files_db.items(),
            key=lambda x: x[1]['download_count'],
            reverse=True
        )[:3]

        if popular_files:
            stats_text += "\nğŸ”¥ Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§:\n"
            for i, (unique_id, file_info) in enumerate(popular_files, 1):
                stats_text += f"{i}. {file_info['file_name']} ({file_info['download_count']} Ø¯Ø§Ù†Ù„ÙˆØ¯)\n"

        await query.edit_message_text(stats_text)

    elif query.data == 'broadcast':
        if is_admin(user_id):
            await query.answer("ğŸ“¢ Ø­Ø§Ù„Øª Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯.")
            return  # ConversationHandler Ø®ÙˆØ¯Ø´ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒØ¯Ù‡


async def handle_file(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ÛŒ"""
    user_id = update.effective_user.id

    if not is_admin(user_id):
        await update.message.reply_text("âŒ Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù†ÛŒØ³ØªÛŒØ¯!")
        return

    if not context.user_data.get('waiting_for_file', False):
        return

    await update.message.reply_text("Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„...")

    # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„
    file_obj = None
    file_name = ""
    file_size = 0
    file_type = ""

    if update.message.document:
        file_obj = update.message.document
        file_name = file_obj.file_name or "document"
        file_size = file_obj.file_size
        file_type = "Ø³Ù†Ø¯"
    elif update.message.video:
        file_obj = update.message.video
        file_name = f"video_{file_obj.file_id[:8]}.mp4"
        file_size = file_obj.file_size
        file_type = "ÙˆÛŒØ¯ÛŒÙˆ"
    elif update.message.audio:
        file_obj = update.message.audio
        file_name = file_obj.file_name or f"audio_{file_obj.file_id[:8]}.mp3"
        file_size = file_obj.file_size
        file_type = "ØµÙˆØª"
    elif update.message.photo:
        file_obj = update.message.photo[-1]  # Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ú©ÛŒÙÛŒØª
        file_name = f"photo_{file_obj.file_id[:8]}.jpg"
        file_size = file_obj.file_size
        file_type = "ØªØµÙˆÛŒØ±"
    else:
        await update.message.reply_text("âŒ Ù†ÙˆØ¹ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯!")
        return

    # Ø°Ø®ÛŒØ±Ù‡ ÙÛŒØ²ÛŒÚ©ÛŒ ÙØ§ÛŒÙ„ Ø¯Ø± Ù¾ÙˆØ´Ù‡ Ù…ÙˆÙ‚Øª
    downloaded_file = await file_obj.get_file()
    temp_file_path = os.path.join(FILES_DIR, file_name) # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² FILES_DIR Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾ÙˆØ´Ù‡ Ù…ÙˆÙ‚Øª
    await downloaded_file.download_to_drive(temp_file_path)

    # Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ
    google_drive_link = None
    try:
        google_drive_link = upload_to_drive(temp_file_path, file_name)
    except Exception as e:
        await update.message.reply_text("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ!")
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ: {e}")
    finally:
         # Ø­Ø°Ù ÙØ§ÛŒÙ„ Ù…ÙˆÙ‚Øª Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ù¾Ù„ÙˆØ¯ ÛŒØ§ Ø®Ø·Ø§
         if os.path.exists(temp_file_path):
              os.remove(temp_file_path)

    if not google_drive_link:
        return # Ø§Ú¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ Ø¯Ø±Ø§ÛŒÙˆ Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯ØŒ Ù…ØªÙˆÙ‚Ù Ø´ÙˆØ¯


    # Ø«Ø¨Øª Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ Ø¨Ù‡ Ø¬Ø§ÛŒ Ù…Ø³ÛŒØ± Ù…Ø­Ù„ÛŒ)
    file_info = {
        'file_name': file_name,
        'file_path': google_drive_link,   # Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ
        'file_size': file_size,
        'file_type': file_type,
        'uploader_id': user_id
    }
    unique_id = file_manager.add_file(file_obj.file_id, file_info)

    # ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø±Ø¨Ø§Øª
    bot_username = context.bot.username
    direct_link = f"https://t.me/{bot_username}?start=get_{unique_id}"


    # ÙØ±Ù…Øª Ø­Ø¬Ù… ÙØ§ÛŒÙ„
    if file_size < 1024:
        size_str = f"{file_size} Ø¨Ø§ÛŒØª"
    elif file_size < 1024 * 1024:
        size_str = f"{file_size / 1024:.1f} Ú©ÛŒÙ„ÙˆØ¨Ø§ÛŒØª"
    else:
        size_str = f"{file_size / (1024 * 1024):.1f} Ù…Ú¯Ø§Ø¨Ø§ÛŒØª"

    success_message = f"""
âœ… ÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯!

ğŸ“ Ù†Ø§Ù… ÙØ§ÛŒÙ„: {file_name}
ğŸ“Š Ø­Ø¬Ù…: {size_str}
ğŸ·ï¸ Ù†ÙˆØ¹: {file_type}
ğŸ†” Ú©Ø¯ ÙØ§ÛŒÙ„: {unique_id}

ğŸ”— Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø±Ø¨Ø§Øª:
{direct_link}

ğŸ”— Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ:
{google_drive_link}

ğŸ“‹ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„:
Ø¯Ú©Ù…Ù‡ Ø¨Ø§ Ù…ØªÙ† "Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„" Ùˆ Ù„ÛŒÙ†Ú© Ø±Ø¨Ø§Øª Ø¨Ø³Ø§Ø²ÛŒØ¯

ğŸ’¡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ØŒ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯
"""

    await update.message.reply_text(success_message)
    context.user_data['waiting_for_file'] = False

    logger.info(f"ÙØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯ Ùˆ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ Ù…Ù†ØªÙ‚Ù„ Ø´Ø¯: {file_name} ØªÙˆØ³Ø· {user_id}")

async def handle_delete_request(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø­Ø°Ù ÙØ§ÛŒÙ„"""
    user_id = update.effective_user.id

    if not is_admin(user_id):
        return

    if not context.user_data.get('waiting_for_delete', False):
        return

    file_code = update.message.text.strip()

    if file_manager.delete_file(file_code):
        await update.message.reply_text(f"âœ… ÙØ§ÛŒÙ„ Ø¨Ø§ Ú©Ø¯ {file_code} Ø­Ø°Ù Ø´Ø¯!")
        logger.info(f"ÙØ§ÛŒÙ„ Ø­Ø°Ù Ø´Ø¯: {file_code} ØªÙˆØ³Ø· {user_id}")
    else:
        await update.message.reply_text(f"âŒ ÙØ§ÛŒÙ„ Ø¨Ø§ Ú©Ø¯ {file_code} ÛŒØ§ÙØª Ù†Ø´Ø¯!")

    context.user_data['waiting_for_delete'] = False

async def get_file_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¯Ø³ØªÙˆØ± Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„"""
    if not context.args:
        await update.message.reply_text("âŒ Ú©Ø¯ ÙØ§ÛŒÙ„ Ù…Ø´Ø®Øµ Ù†Ø´Ø¯Ù‡!")
        return

    file_code = context.args[0]

    # Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ù…Øª get_XXXXXX
    if file_code.startswith('get_'):
        unique_id = file_code[4:]  # Ø­Ø°Ù get_
    else:
        unique_id = file_code

    file_info = file_manager.get_file(unique_id)

    if not file_info:
        await update.message.reply_text("âŒ ÙØ§ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø§Ø³Øª!")
        return

    # Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ú©Ù‡ Ø§Ø² Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    await send_file_from_drive(update, context, file_info, unique_id)


# Broadcast functionality
WAITING_BROADCAST = 1

async def broadcast_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ"""
    # Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ØªÙˆØ³Ø· ConversationHandler Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† entry_point ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    # Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± button_handler Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯Ù‡ØŒ Ø§Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ…
    if not is_admin(update.effective_user.id):
        await update.message.reply_text("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù†Ø¯Ø§Ø±ÛŒØ¯!")
        return ConversationHandler.END

    await update.message.reply_text("ğŸ“¢ Ù¾ÛŒØ§Ù… Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± Ø±Ùˆ Ø¨ÙØ±Ø³Øª ØªØ§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ù….")
    return WAITING_BROADCAST

async def broadcast_send(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†"""
    if not is_admin(update.effective_user.id):
        return ConversationHandler.END

    sent_count = 0
    failed_count = 0

    await update.message.reply_text("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ...")

    # Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª user_id Ù‡Ø§ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    user_ids = list(file_manager.users_db.keys())

    for user_id_str in user_ids:
        user_id = int(user_id_str) # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± chat_id
        try:
            if update.message.text:
                await context.bot.send_message(chat_id=user_id, text=update.message.text)
            elif update.message.photo:
                await context.bot.send_photo(chat_id=user_id, photo=update.message.photo[-1].file_id, caption=update.message.caption or "")
            elif update.message.video:
                await context.bot.send_video(chat_id=user_id, video=update.message.video.file_id, caption=update.message.caption or "")
            elif update.message.document:
                await context.bot.send_document(chat_id=user_id, document=update.message.document.file_id, caption=update.message.caption or "")
            else:
                 # Ø§Ú¯Ø± Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ø´ÙˆØ¯
                 continue

            sent_count += 1
            await asyncio.sleep(0.1) # ØªØ§Ø®ÛŒØ± Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯ÛŒØª rate limit

        except Exception as e:
            failed_count += 1
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ Ø¨Ù‡ {user_id}: {e}")
            # Optionally, you can remove the user from the database if sending fails consistently
            # del file_manager.users_db[user_id_str]
            # file_manager.save_users_db()


    await update.message.reply_text(f"âœ… Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!\nØ§Ø±Ø³Ø§Ù„ Ù…ÙˆÙÙ‚: {sent_count}\nØ§Ø±Ø³Ø§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚: {failed_count}")
    context.user_data.pop('waiting_for_broadcast', None) # Ø­Ø°Ù Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø±
    return ConversationHandler.END

async def broadcast_cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù„ØºÙˆ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ"""
    if not is_admin(update.effective_user.id):
        return ConversationHandler.END
    await update.message.reply_text("âŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ Ù„ØºÙˆ Ø´Ø¯.")
    context.user_data.pop('waiting_for_broadcast', None) # Ø­Ø°Ù Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø±
    return ConversationHandler.END


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ"""
    user_id = update.effective_user.id

    # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø­Ø°Ù ÙØ§ÛŒÙ„
    if is_admin(user_id) and context.user_data.get('waiting_for_delete', False):
        await handle_delete_request(update, context)
        return

    # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ
    # Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… ØªÙˆØ³Ø· Ù‡Ù†Ø¯Ù„Ø± ConversationHandler Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ù¾Ø³ Ø§ÛŒÙ†Ø¬Ø§ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†ÛŒØ³Øª


    # Ù¾ÛŒØ§Ù… Ø¹Ø§Ø¯ÛŒ
    if is_admin(user_id):
        await update.message.reply_text("ğŸ‘‘ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ ÛŒØ§ /start Ø¨Ø²Ù†ÛŒØ¯")
    else:
        await update.message.reply_text("ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„ Ø§Ø² Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯")

import nest_asyncio
import asyncio
from pydrive2.auth import GoogleAuth
from pydrive2.drive import GoogleDrive

# Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ
# Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„ credentials.json Ø¯Ø± Ù¾ÙˆØ´Ù‡ Colab
# Ø§Ú¯Ø± Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± Ø§Ø³ØªØŒ Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
drive = None # Initialize drive to None
try:
    gauth = GoogleAuth()
    # Ø¨Ø±Ø§ÛŒ ColabØŒ Ø§Ø² WebServerAuth Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†ÛŒØ¯
    gauth.LocalWebserverAuth()
    drive = GoogleDrive(gauth)
except Exception as e:
    logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ: {e}")
    # Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø±Ø¨Ø§Øª Ø±Ø§ Ù…ØªÙˆÙ‚Ù Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø¯ÙˆÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ Ø¯Ø±Ø§ÛŒÙˆ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯


def upload_to_drive(local_path, filename):
    """Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ Ùˆ Ú¯Ø±ÙØªÙ† Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯"""
    if drive is None:
        logger.error("Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª!")
        return None
    try:
        file_drive = drive.CreateFile({'title': filename})
        file_drive.SetContentFile(local_path)
        file_drive.Upload()
        # Ú¯Ø±ÙØªÙ† Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ
        file_drive.InsertPermission({'type': 'anyone', 'value': 'anyone', 'role': 'reader'})
        logger.info(f"ÙØ§ÛŒÙ„ {filename} Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯: {file_drive['id']}")
        return f"https://drive.google.com/uc?id={file_drive['id']}"
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ {filename} Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø¯Ø±Ø§ÛŒÙˆ: {e}")
        return None


nest_asyncio.apply()  # Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ event loop Ø¯Ø± Colab/Jupyter

async def main():
    application = Application.builder().token(BOT_TOKEN).build()

    # Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("get", get_file_command))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(MessageHandler(
        filters.Document.ALL | filters.VIDEO | filters.AUDIO | filters.PHOTO,
        handle_file
    ))
    # application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message)) # Ø§ÛŒÙ† Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø§ ConversationHandler ØªØ¯Ø§Ø®Ù„ Ø¯Ø§Ø±Ø¯

    # ConversationHandler Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù‡Ù…Ú¯Ø§Ù†ÛŒ
    broadcast_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(broadcast_start, pattern='^broadcast$')],
        states={
            WAITING_BROADCAST: [MessageHandler(filters.ALL & ~filters.COMMAND, broadcast_send)],
        },
        fallbacks=[CommandHandler("cancel", broadcast_cancel)],
        # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†Ù†Ø¯
        # filter=filters.User(user_id=ADMIN_IDS) # ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¢ÛŒØ¯ÛŒ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§
        allow_reentry=True # Ø§Ø¬Ø§Ø²Ù‡ ÙˆØ±ÙˆØ¯ Ù…Ø¬Ø¯Ø¯ Ø¨Ù‡ Ú¯ÙØªÚ¯Ùˆ Ø¯Ø± ØµÙˆØ±Øª Ù‚Ø·Ø¹ Ø´Ø¯Ù†
    )
    application.add_handler(broadcast_handler)

    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„Ø± Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ Ø¹Ø§Ø¯ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² ConversationHandler
    # Ø§ÛŒÙ† Ù‡Ù†Ø¯Ù„Ø± ÙÙ‚Ø· Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒÛŒ Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ ØªÙˆØ³Ø· ConversationHandler ÛŒØ§ Ø³Ø§ÛŒØ± Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))


    logger.info("ğŸš€ Ø±Ø¨Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§ÛŒÙ„ Ø´Ø±ÙˆØ¹ Ø´Ø¯...")
    print("ğŸ¤– Ø±Ø¨Ø§Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª! Ctrl+C Ø¨Ø±Ø§ÛŒ ØªÙˆÙ‚Ù")
    print(f"ğŸ‘‘ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§: {ADMIN_IDS}")

    # Ø§Ø¬Ø±Ø§ÛŒ async
    await application.run_polling(drop_pending_updates=True)

# Ø¨Ø±Ø§ÛŒ Colab / Jupyter:
await main()
